---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Action test/validation workflow
name: "Test GitHub Action ðŸ§ª"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  ### Prepare test releases (both draft and published) ###
  prepare-test-releases:
    name: "Prepare test releases"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    outputs:
      draft_tag: "${{ steps.create-releases.outputs.draft_tag }}"
      draft_name: "${{ steps.create-releases.outputs.draft_name }}"
      published_tag: "${{ steps.create-releases.outputs.published_tag }}"
      published_name: "${{ steps.create-releases.outputs.published_name }}"
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test releases"
        id: create-releases
        env:
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        shell: bash
        run: |
          # Create test releases
          TIMESTAMP=$(date +%s)
          DRAFT_TAG="test-draft-$TIMESTAMP"
          DRAFT_NAME="Test Draft Release $TIMESTAMP"
          PUBLISHED_TAG="test-published-$TIMESTAMP"
          PUBLISHED_NAME="Test Published Release $TIMESTAMP"

          echo "Creating draft release: $DRAFT_NAME ($DRAFT_TAG)"
          gh release create "$DRAFT_TAG" \
            --draft \
            --title "$DRAFT_NAME" \
            --notes "Test draft release for action validation"

          echo "Creating published release: $PUBLISHED_NAME ($PUBLISHED_TAG)"
          gh release create "$PUBLISHED_TAG" \
            --title "$PUBLISHED_NAME" \
            --notes "Test published release for action validation"

          echo "draft_tag=$DRAFT_TAG" >> "$GITHUB_OUTPUT"
          echo "draft_name=$DRAFT_NAME" >> "$GITHUB_OUTPUT"
          echo "published_tag=$PUBLISHED_TAG" >> "$GITHUB_OUTPUT"
          echo "published_name=$PUBLISHED_NAME" >> "$GITHUB_OUTPUT"

          {
            echo "## Test Releases Created"
            echo "- Draft: $DRAFT_NAME ($DRAFT_TAG)"
            echo "- Published: $PUBLISHED_NAME ($PUBLISHED_TAG)"
          } >> "$GITHUB_STEP_SUMMARY"

  ### Test with DRAFT release ###
  test-draft-single-file:
    name: "Test: Draft release - Single file"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test file"
        shell: bash
        run: |
          # Create test file
          mkdir -p dist
          echo "Draft test content $(date)" > dist/draft-test.txt

      - name: "Upload to draft release"
        id: upload
        uses: ./
        with:
          asset_paths: '["dist/draft-test.txt"]'
          release_tag: "${{ needs.prepare-test-releases.outputs.draft_tag }}"

      - name: "Verify upload and download"
        shell: bash
        env:
          URLS: "${{ steps.upload.outputs.download_urls }}"
        run: |
          # Verify upload and download
          echo "Download URLs: $URLS"
          if [ -z "$URLS" ]; then
            echo "Error: No download URLs returned âŒ"
            exit 1
          fi

          # Extract first URL and verify it's downloadable
          URL=$(echo "$URLS" | jq -r '.[0]')
          echo "Testing download from: $URL"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$URL")
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: Download failed with HTTP $HTTP_CODE âŒ"
            exit 1
          fi

          echo "âœ… Draft release single file test successful"

  test-draft-glob-pattern:
    name: "Test: Draft release - Glob patterns"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test files"
        shell: bash
        run: |
          # Create test files
          mkdir -p dist
          echo "File 1" > dist/file1.txt
          echo "File 2" > dist/file2.txt
          echo "File 3" > dist/file3.log
          echo "Archive 1" > dist/archive1.tar.gz
          echo "Archive 2" > dist/archive2.tar.gz

      - name: "Upload with glob pattern"
        id: upload
        uses: ./
        with:
          asset_paths: '["dist/*.txt", "dist/*.tar.gz"]'
          release_tag: "${{ needs.prepare-test-releases.outputs.draft_tag }}"

      - name: "Verify multiple files uploaded and downloadable"
        shell: bash
        env:
          URLS: "${{ steps.upload.outputs.download_urls }}"
        run: |
          # Verify multiple files uploaded and downloadable
          echo "Download URLs: $URLS"
          COUNT=$(echo "$URLS" | jq 'length')
          echo "Uploaded $COUNT files"

          if [ "$COUNT" -ne 4 ]; then
            echo "Error: Expected 4 files, got $COUNT âŒ"
            exit 1
          fi

          # Verify each URL is downloadable
          echo "$URLS" | jq -r '.[]' | while read -r url; do
            echo "Testing: $url"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$url")
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Error: Download failed for $url (HTTP $HTTP_CODE) âŒ"
              exit 1
            fi
          done

          echo "âœ… Draft release glob pattern test successful"

  ### Test with PUBLISHED release ###
  test-published-single-file:
    name: "Test: Published release - Single file"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test file"
        shell: bash
        run: |
          # Create test file
          mkdir -p dist
          echo "Published test content $(date)" > dist/published-test.txt

      - name: "Upload to published release"
        id: upload
        uses: ./
        with:
          asset_paths: '["dist/published-test.txt"]'
          release_tag: "${{ needs.prepare-test-releases.outputs.published_tag }}"

      - name: "Verify upload and download"
        shell: bash
        env:
          URLS: "${{ steps.upload.outputs.download_urls }}"
        run: |
          # Verify upload and download
          echo "Download URLs: $URLS"
          if [ -z "$URLS" ]; then
            echo "Error: No download URLs returned âŒ"
            exit 1
          fi

          # Extract first URL and verify it's downloadable
          URL=$(echo "$URLS" | jq -r '.[0]')
          echo "Testing download from: $URL"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$URL")
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: Download failed with HTTP $HTTP_CODE âŒ"
            exit 1
          fi

          echo "âœ… Published release single file test successful"

  test-published-multiple-files:
    name: "Test: Published release - Multiple files"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test files"
        shell: bash
        run: |
          # Create test files
          mkdir -p build
          echo "Binary 1" > build/app1.bin
          echo "Binary 2" > build/app2.bin
          echo "Binary 3" > build/app3.bin

      - name: "Upload multiple files"
        id: upload
        uses: ./
        with:
          asset_paths: '["build/*.bin"]'
          release_tag: "${{ needs.prepare-test-releases.outputs.published_tag }}"

      - name: "Verify all files uploaded and downloadable"
        shell: bash
        env:
          URLS: "${{ steps.upload.outputs.download_urls }}"
        run: |
          # Verify all files uploaded and downloadable
          COUNT=$(echo "$URLS" | jq 'length')
          echo "Uploaded $COUNT files"

          if [ "$COUNT" -ne 3 ]; then
            echo "Error: Expected 3 files, got $COUNT âŒ"
            exit 1
          fi

          # Download and verify each file
          echo "$URLS" | jq -r '.[]' | while read -r url; do
            filename=$(basename "$url")
            echo "Downloading: $filename from $url"

            if ! curl -sL -o "/tmp/$filename" "$url"; then
              echo "Error: Failed to download $filename âŒ"
              exit 1
            fi

            if [ ! -f "/tmp/$filename" ]; then
              echo "Error: File not saved: $filename âŒ"
              exit 1
            fi

            size=$(stat -f%z "/tmp/$filename" 2>/dev/null || stat -c%s "/tmp/$filename")
            echo "Downloaded $filename ($size bytes)"
          done

          echo "âœ… Published release multiple files test successful"

  test-release-by-name:
    name: "Test: Target by release name"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test file"
        shell: bash
        run: |
          # Create test file
          mkdir -p build
          echo "Name test content" > build/name-test.txt

      - name: "Upload by tag and name"
        id: upload
        uses: ./
        with:
          asset_paths: '["build/name-test.txt"]'
          release_tag: "${{ needs.prepare-test-releases.outputs.draft_tag }}"
          release_name: "${{ needs.prepare-test-releases.outputs.draft_name }}"

      - name: "Verify success and download"
        shell: bash
        env:
          URLS: "${{ steps.upload.outputs.download_urls }}"
        run: |
          # Verify success and download
          URL=$(echo "$URLS" | jq -r '.[0]')
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$URL")
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: Download failed with HTTP $HTTP_CODE âŒ"
            exit 1
          fi
          echo "âœ… Release name targeting successful"

  test-nested-glob:
    name: "Test: Nested directory glob"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create nested files"
        shell: bash
        run: |
          # Create nested files
          mkdir -p artifacts/sub1 artifacts/sub2
          echo "Nested 1" > artifacts/sub1/file.bin
          echo "Nested 2" > artifacts/sub2/file.bin
          echo "Root file" > artifacts/root.bin

      - name: "Upload with nested glob"
        id: upload
        uses: ./
        with:
          asset_paths: '["artifacts/**/*.bin"]'
          release_tag: "${{ needs.prepare-test-releases.outputs.draft_tag }}"

      - name: "Verify nested upload and downloads"
        shell: bash
        env:
          URLS: "${{ steps.upload.outputs.download_urls }}"
        run: |
          # Verify nested upload and downloads
          COUNT=$(echo "$URLS" | jq 'length')
          echo "Uploaded $COUNT files from nested directories"

          if [ "$COUNT" -ne 3 ]; then
            echo "Error: Expected 3 files, got $COUNT âŒ"
            exit 1
          fi

          # Verify all are downloadable
          echo "$URLS" | jq -r '.[]' | while read -r url; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$url")
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Error: Download failed for $url (HTTP $HTTP_CODE) âŒ"
              exit 1
            fi
          done

          echo "âœ… Nested glob test successful"

  ### Failure tests ###
  test-failure-invalid-json:
    name: "Test: Invalid JSON input (expect failure)"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Test invalid JSON"
        id: invalid-json
        continue-on-error: true
        uses: ./
        with:
          asset_paths: 'not valid json'
          release_tag: "${{ needs.prepare-test-releases.outputs.draft_tag }}"

      - name: "Verify failure"
        if: steps.invalid-json.outcome == 'success'
        shell: bash
        run: |
          # Verify failure
          echo "Error: Action should have failed with invalid JSON âŒ"
          exit 1

      - name: "Confirm expected failure"
        if: steps.invalid-json.outcome == 'failure'
        shell: bash
        run: |
          # Confirm expected failure
          echo "âœ… Invalid JSON test passed (correctly failed)"

  test-failure-no-release:
    name: "Test: Non-existent release (expect failure)"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test file"
        shell: bash
        run: |
          # Create test file
          echo "test" > test.txt

      - name: "Test non-existent release"
        id: no-release
        continue-on-error: true
        uses: ./
        with:
          asset_paths: '["test.txt"]'
          release_tag: "nonexistent-tag-12345"

      - name: "Verify failure"
        if: steps.no-release.outcome == 'success'
        shell: bash
        run: |
          # Verify failure
          echo "Error: Action should have failed with non-existent release âŒ"
          exit 1

      - name: "Confirm expected failure"
        if: steps.no-release.outcome == 'failure'
        shell: bash
        run: |
          # Confirm expected failure
          echo "âœ… Non-existent release test passed (correctly failed)"

  test-failure-name-mismatch:
    name: "Test: Release name mismatch (expect failure)"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Create test file"
        shell: bash
        run: |
          # Create test file
          echo "test" > test.txt

      - name: "Test name mismatch"
        id: name-mismatch
        continue-on-error: true
        uses: ./
        with:
          asset_paths: '["test.txt"]'
          release_tag: "${{ needs.prepare-test-releases.outputs.draft_tag }}"
          release_name: "Wrong Release Name"

      - name: "Verify failure"
        if: steps.name-mismatch.outcome == 'success'
        shell: bash
        run: |
          # Verify failure
          echo "Error: Action should have failed with name mismatch âŒ"
          exit 1

      - name: "Confirm expected failure"
        if: steps.name-mismatch.outcome == 'failure'
        shell: bash
        run: |
          # Confirm expected failure
          echo "âœ… Name mismatch test passed (correctly failed)"

  test-failure-empty-array:
    name: "Test: Empty asset paths array (expect failure)"
    needs: prepare-test-releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Test empty array"
        id: empty-array
        continue-on-error: true
        uses: ./
        with:
          asset_paths: '[]'
          release_tag: "${{ needs.prepare-test-releases.outputs.draft_tag }}"

      - name: "Verify failure"
        if: steps.empty-array.outcome == 'success'
        shell: bash
        run: |
          # Verify failure
          echo "Error: Action should have failed with empty array âŒ"
          exit 1

      - name: "Confirm expected failure"
        if: steps.empty-array.outcome == 'failure'
        shell: bash
        run: |
          # Confirm expected failure
          echo "âœ… Empty array test passed (correctly failed)"

  ### Cleanup ###
  cleanup-test-releases:
    name: "Cleanup test releases"
    needs:
      - prepare-test-releases
      - test-draft-single-file
      - test-draft-glob-pattern
      - test-published-single-file
      - test-published-multiple-files
      - test-release-by-name
      - test-nested-glob
      - test-failure-invalid-json
      - test-failure-name-mismatch
      - test-failure-empty-array
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 5
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Delete test releases"
        env:
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        shell: bash
        run: |
          # Delete test releases
          DRAFT_TAG="${{ needs.prepare-test-releases.outputs.draft_tag }}"
          PUBLISHED_TAG="${{ needs.prepare-test-releases.outputs.published_tag }}"

          if [ -n "$DRAFT_TAG" ]; then
            echo "Deleting draft release: $DRAFT_TAG"
            gh release delete "$DRAFT_TAG" --yes || true
          fi

          if [ -n "$PUBLISHED_TAG" ]; then
            echo "Deleting published release: $PUBLISHED_TAG"
            gh release delete "$PUBLISHED_TAG" --yes || true
          fi

          echo "âœ… Cleanup completed"
          echo "## Cleanup Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Deleted draft release: $DRAFT_TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "- Deleted published release: $PUBLISHED_TAG" >> "$GITHUB_STEP_SUMMARY"

  ### Final test summary ###
  test-summary:
    name: "Test Summary"
    needs:
      - test-draft-single-file
      - test-draft-glob-pattern
      - test-published-single-file
      - test-published-multiple-files
      - test-release-by-name
      - test-nested-glob
      - test-failure-invalid-json
      - test-failure-no-release
      - test-failure-name-mismatch
      - test-failure-empty-array
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: "Generate test summary"
        shell: bash
        run: |
          # Generate test summary
          {
            echo "# Test Results Summary ðŸ§ª"
            echo ""
            echo "## Draft Release Tests"
            echo "- Single file upload: âœ…"
            echo "- Glob pattern matching: âœ…"
            echo ""
            echo "## Published Release Tests"
            echo "- Single file upload: âœ…"
            echo "- Multiple files: âœ…"
            echo ""
            echo "## Additional Tests"
            echo "- Release name targeting: âœ…"
            echo "- Nested glob patterns: âœ…"
            echo ""
            echo "## Negative Tests (Expected Failures)"
            echo "- Invalid JSON input: âœ…"
            echo "- Non-existent release: âœ…"
            echo "- Name mismatch: âœ…"
            echo "- Empty array: âœ…"
            echo ""
            echo "## Verification"
            echo "- All uploaded assets verified as downloadable âœ…"
            echo "- Test releases cleaned up âœ…"
          } >> "$GITHUB_STEP_SUMMARY"
